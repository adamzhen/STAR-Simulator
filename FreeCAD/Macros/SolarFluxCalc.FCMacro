import sys
sys.path.append(r"\\storage.it.tamu.edu\TAMU\OAL\Homes\adzheng\Programs\Python\site-packages\python3.10")
import FreeCAD
import otsun
import os

# ============================================================================
# CLEAR MATERIAL REGISTRY
# ============================================================================
from otsun.materials import Material

# Clear any existing "Aluminum" material
if "Aluminum" in Material.by_name:
    print("Removing old Aluminum material definition...")
    del Material.by_name["Aluminum"]

# ============================================================================
# FACE EXTRACTION FUNCTION
# ============================================================================

def extract_faces_from_solid(doc, solid_obj_label, material_name):
    solid = doc.getObjectsByLabel(solid_obj_label)[0]
    print(f"Extracting {len(solid.Shape.Faces)} faces from '{solid_obj_label}'...")
    
    face_objects = []
    for i, face in enumerate(solid.Shape.Faces):
        face_obj = doc.addObject("Part::Feature", f"{solid.Name}_Face{i}")
        face_obj.Shape = face
        face_obj.Label = f"{solid.Label}_Face{i}Mat{material_name}"
        face_objects.append(face_obj)
    
    doc.removeObject(solid.Name)
    doc.recompute()
    print(f"Extracted {len(face_objects)} faces")
    return face_objects


# ============================================================================
# MAIN SIMULATION SCRIPT
# ============================================================================

FCSTD_PATH = 'H:/Programs/FreeCAD 1.0/data/examples/Cube.FCStd'

# --- Create Working Copy ---
temp_path = FCSTD_PATH.replace('.FCStd', '_otsun_working.FCStd')
original_doc = FreeCAD.open(FCSTD_PATH)
original_doc.saveAs(temp_path)
FreeCAD.closeDocument(original_doc.Name)
doc = FreeCAD.open(temp_path)

# --- Rotate Cube  ---
cube = doc.getObjectsByLabel("Cube(Aluminum)")[0]  # Get by display label
cube.Placement.Rotation = FreeCAD.Rotation(FreeCAD.Base.Vector(1, 0, 0), 30)

# --- Extract Faces from Solid ---
extract_faces_from_solid(doc, "Cube(Aluminum)", "Aluminum")

# --- Define Surface Material (FRESH) ---
from otsun.materials import SurfaceMaterial

SurfaceMaterial.create("Aluminum", {
    "probability_of_reflection": lambda wl: 0.0,
    "probability_of_absorption": lambda wl: 1.0,
    "probability_of_transmittance": lambda wl: 0.0,
    'thermal_material': True
})

# --- VERIFY Material Properties ---
print("\n=== Material Verification ===")
aluminum_mat = Material.by_name["Aluminum"]
print(f"  Material type: {type(aluminum_mat).__name__}")
print(f"  Properties: {aluminum_mat.properties}")

# --- Build Scene ---
scene = otsun.Scene.from_freecad_document(doc)

print(f"\n=== Scene ===")
print(f"  Faces in scene: {len(scene.faces)}")

# --- Define Sun/Light Source ---
from otsun.source import SunWindow, LightSource

main_direction = FreeCAD.Base.Vector(0, 0, -1)
sun_window = SunWindow(scene, main_direction)

sun = LightSource(
    scene=scene,
    emitting_region=sun_window,
    light_spectrum=550.0,
    initial_energy=1.0,
    direction_distribution=None,
    polarization_vector=None
)

# --- Run Experiment ---
num_rays = 1000
experiment = otsun.Experiment(
    scene=scene,
    light_source=sun,
    number_of_rays=num_rays,
    document_to_show=doc
)

print(f"\n=== Running simulation with {num_rays} rays ===")
experiment.run()

# --- Results ---
print(f"\n=== RESULTS ===")
print(f"Total absorbed energy: {experiment.captured_energy_Th} J")
print(f"Number of absorption points: {len(experiment.points_absorber_Th)}")

# Save flux data
import csv
DATA_FILEPATH = 'H:/STAR-Simulator/FreeCAD/flux_data.csv'
with open(DATA_FILEPATH, 'w', newline='') as f:
    writer = csv.writer(f)
    writer.writerow(['Energy', 'X', 'Y', 'Z', 'Normal_X', 'Normal_Y', 'Normal_Z', 'Wavelength'])
    
    for entry in experiment.points_absorber_Th:
        energy, x1, y1, z1, x2, y2, z2, nx, ny, nz, wavelength = entry
        writer.writerow([energy, x1, y1, z1, nx, ny, nz, wavelength])

print(f"\nFlux data saved: {len(experiment.points_absorber_Th)} points")

doc.save()
doc.recompute()
